# 子集 {#subsetting}
```{r setup, include = FALSE}
source("common.R")
```

## 概述

R语言的子集操作符是高效且强大的，掌握它们可以让您用其它语言无可比拟的简洁方式去执行复杂的子集操作。R语言子集很容易学习，但很难掌握，
因为您需要熟悉很多相互关联的概念：

- 有六种方法可以对院子向量取子集。
- 有三种子集操作符，`[[`，`[`，`$`。
- 子集运算符作用在不同类型的向量上返回的结果不同（如，原子向量，列表，因子，矩阵和数据框）。
- 取子集操作可以与赋值合并。

子集是`str()`函数的自然补充。`str()`函数显示任何对象的所有片段，而子集允许您查看所有感兴趣的片段。对于大型、复杂的对象，我强烈建议使用交互式RStudio数据查看器，
您可以使用`View(my_object)`打开。

### 测试 {-}

花一点时间测试一下您是否需要阅读本章。如果每道题目的结果立刻出现在您的脑海，那么您可以直接开始下一章。测试题的答案在\@ref(subsetting-quiz-answer)小节。

1. 使用负整数、正整数、逻辑向量或字符向量对一个向量取子集的结果是什么？

2. 将`[`，`[[`和`$`作用于一个列表，得到的结果有何不同？

3. 在何种情况下使用`drop = FALSE`？

4. 如果`x`是一个矩阵，那么`x[] <- 0`将得到什么？这与`x <- 0`有何不同？

5. 如何使用命名向量重新标记分类变量？

### 题纲 {-}

- 第\@ref(subset-multiple)节开始教您如何使用`[`，您将学习六个为原子向量取子集的方法，您也会学习到如何用这六种方法对矩阵、列表、数据框取子集。
- 第\@ref(subset-single)节扩展您对子集运算符的知识，包括`[[`和`$`，并重点聚焦在简化与保留的原则上。
- 第\@ref(subsetting-assignment)节您将学习子集赋值的方法，它通过取子集和子集赋值来改变对象的某些部分。
- 第\@ref(subsetting-applications)节带领您完成八个重要但不明显的子集应用，以解决您在数据分析中经常遇到的问题。

## 选择多个元素 {#subset-multiple}

使用`[`从向量中选择任意数量的元素，为了展示这一点，我将采用一维原子向量，然后说明如何将其推广到更复杂的对象和更高的维度。

### 原子向量

让我们用不同的取子集方式来探索一个简单向量`x`。

```{r}
x <- c(2.1, 4.2, 3.3, 5.4)
```

请注意，小数点后的数字表示向量中的原始位置。

有以下六种方式可以给一个向量取子集：

- **正整数**返回特定位置的元素：

```{r}
x[c(3, 1)]
x[order(x)]

# 重复的索引将带来重复的值
x[c(1, 1)]

# 实数索引会被截断为整数
x[c(2.1, 2.9)]
```

- **负整数**排除指定位置的元素：

```{r}
x[-c(3, 1)]
```

请注意，不能在单个子集中混合使用正整数和负整数。

```{r, error = TRUE}
x[c(-1, 2)]
```

- **逻辑向量**选择对应逻辑值为`TRUE`的元素，这可能是最有用的取子集方式，因为您可以方便的编写使用逻辑向量的表达式。

```{r}
x[c(TRUE, TRUE, FALSE, FALSE)]

x[x > 3]
```

在`x[y]`中，如果`x`与`y`长度不同会发生什么？这种行为遵从**循环原则**，即两者之中较短的向量循环补齐至较长的向量。当`x`和`y`其中一个长度为1时，这很方便也容易理解，
但我建议应避免对其他长度的向量采用循环原则，因为这个规则在Base R包中的应用不一致。

```{r}
x[c(TRUE, FALSE)]
# 相当于
x[c(TRUE, FALSE, TRUE, FALSE)]
```

请注意，以缺失值为索引依然会返回缺失值。

```{r}
x[c(TRUE, TRUE, NA, FALSE)]
```

- **空索引**返回原始向量。这对于一维向量并没有什么用，但是很快您就能看到，这对于矩阵、数据框和数组是十分有用的。这种方式还可以与赋值同时使用。

```{r}
x[]
```

- **零索引**返回一个长度为0的向量。一般我们不会这么做，但它对于生成测试数据非常有用。

```{r}
x[0]
```

- 如果是命名向量，还可以使用**字符向量**返回与名称匹配的元素。

```{r}
(y <- setNames(x, letters[1:4]))
y[c("d", "c", "a")]

# 就像整型索引，您也可以使用重复的字符索引
y[c("a", "a", "a")]

# 当使用 [ 取子集时，命名列会精准匹配
z <- c(abc = 1, def = 2)
z[c("a", "d")]
```

注意：在进行子集操作时，没有对因子进行特殊处理。这就意味着使用因子对向量取子集其实使用的是因子的数值级别，而不是字符级别。这往往不是我们所需要的，因此您应尽量避免使用因子来取子集：

```{r}
y[factor("b")]
```

### 列表

列表子集的操作与向量子集类似，使用`[`会返回一个列表；使用`[[`和`$`会返回一个元素，详见\@ref(matrix-subsetting)节

### 矩阵和数组 {#matrix-subsetting}

您可以使用以下三种方式对一个高维结构取子集：

- 用多维向量
- 用一维向量
- 用矩阵

对二维矩阵或者二维以上的数组取子集最常见的方式是使用一维向量为索引：为每一个维度提供一维向量，用逗号分隔。空索引这个时间很有用，它可以让您保留全部行或列。

```{r}
a <- matrix(1:9, nrow = 3)
colnames(a) <- c("A", "B", "C")
a[1:2, ]

a[c(TRUE, FALSE, TRUE), c("B", "A")]

a[0, -2]
```

默认情况下，`[`将结果简化为尽可能低的维度。例如，以下表达式都返回一维向量，您将在\@ref(preserving-dimensionality)节学习如何避免“丢失”维度。

```{r}
a[1, ]
a[1, 1]
```

### 数据框和tibble

### 保维 {#preserving-dimensionality}

### 习题

## 选择单个元素 {#subset-single}

### `[[`

### `$`

### 缺失索引与越界索引

### `@`和`slot()`

### 习题

## 取子集与子集赋值 {#subsetting-assignment}

## 应用 {#subsetting-applications}

### 查找表（字符型索引）{#lookup-tables}

### 手动匹配与合并（整型索引）

### 随机抽样与关联（整型索引）

### 排序（整型索引）

### 聚合统计的扩展（整型索引）

### 数据框的列删除（字符型索引）

### 行的条件选择（逻辑型索引）

### 布尔代数与集合（逻辑型与整型索引）

### 习题

## 测试题答案 {#subsetting-quiz-answer}
